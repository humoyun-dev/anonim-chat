<%- include("partials/layout-top", { title, active }) %>

<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">Users <span class="badge bg-secondary ms-2"><%= totalCount %></span></h1>
    <a class="btn btn-sm btn-outline-light" href="/chat">Open Chat</a>
  </div>

  <% if (typeof flash !== 'undefined' || (typeof require !== 'undefined')) { %>
  <% const flashMsg = typeof require !== 'undefined' ? '' : ''; %>
  <% } %>

  <form class="row g-2 mb-3" method="GET" action="/users">
    <div class="col-md-10">
      <input
        type="text"
        class="form-control"
        name="search"
        placeholder="Search users by name or username..."
        value="<%= search %>"
      />
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" type="submit">Search</button>
    </div>
  </form>

  <div class="card border-0" style="background: rgba(15,23,42,0.55); border: 1px solid rgba(255,255,255,0.08) !important;">
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Name</th>
            <th>Username</th>
            <th style="width: 240px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (users.length === 0) { %>
          <tr><td colspan="4" class="text-center text-muted py-4">No users found.</td></tr>
          <% } %>
          <% users.forEach((user) => { %>
          <tr>
            <td><code><%= user.userId %></code></td>
            <td><%= (user.firstName || '') + ' ' + (user.lastName || '') %></td>
            <td><%= user.username ? ("@" + user.username) : "â€”" %></td>
            <td>
              <div class="d-flex gap-1 flex-wrap">
                <a href="/user/<%= user.userId %>/detail" class="btn btn-sm btn-outline-light">Conversations</a>
                <form
                  action="/user/<%= user.userId %>/delete"
                  method="POST"
                  style="display: inline-block"
                  onsubmit="return confirm('Delete user <%= user.userId %>?');"
                >
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                </form>
              </div>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <% if (totalPages > 1) { %>
  <nav class="mt-3 d-flex justify-content-center">
    <ul class="pagination pagination-sm">
      <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
        <a class="page-link" href="/users?page=<%= page - 1 %>&search=<%= encodeURIComponent(search) %>">Prev</a>
      </li>
      <% for (let p = Math.max(1, page - 2); p <= Math.min(totalPages, page + 2); p++) { %>
      <li class="page-item <%= p === page ? 'active' : '' %>">
        <a class="page-link" href="/users?page=<%= p %>&search=<%= encodeURIComponent(search) %>"><%= p %></a>
      </li>
      <% } %>
      <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="/users?page=<%= page + 1 %>&search=<%= encodeURIComponent(search) %>">Next</a>
      </li>
    </ul>
  </nav>
  <% } %>
</div>

<%- include("partials/layout-bottom") %>
