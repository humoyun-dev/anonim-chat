<%- include("partials/layout-top", { title, active }) %>

<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">Messages</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-light" href="/export/messages">Export CSV</a>
      <a class="btn btn-sm btn-outline-light" href="/chat">Open Chat</a>
    </div>
  </div>

  <form class="row g-2 mb-3" method="GET" action="/messages">
    <div class="col-md-4">
      <input type="date" class="form-control" name="from" value="<%= from %>" />
    </div>
    <div class="col-md-4">
      <input type="date" class="form-control" name="to" value="<%= to %>" />
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary w-100" type="submit">Filter</button>
    </div>
  </form>

  <div class="card border-0" style="background: rgba(15,23,42,0.55); border: 1px solid rgba(255,255,255,0.08) !important;">
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Sender</th>
            <th>Recipient</th>
            <th>Message</th>
            <th>Timestamp</th>
            <th style="width: 120px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% messages.forEach((message) => { %>
          <tr>
            <td><%= message.sender %></td>
            <td><%= message.recipient %></td>
            <td>
              <%= (message.text && message.text.trim())
                ? message.text
                : ("[" + (message.kind || "media") + "]") %>
            </td>
            <td><%= new Date(message.timestamp).toLocaleString() %></td>
            <td>
              <form
                action="/message/<%= message._id %>/delete"
                method="POST"
                onsubmit="return confirm('Delete this message?');"
              >
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <button class="btn btn-sm btn-outline-danger" type="submit">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%- include("partials/layout-bottom") %>
