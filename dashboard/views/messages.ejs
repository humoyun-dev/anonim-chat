<%- include("partials/layout-top", { title, active }) %>

<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">Messages <span class="badge bg-secondary ms-2"><%= totalCount %></span></h1>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-light" href="/export/messages">ðŸ“¥ Export CSV</a>
      <a class="btn btn-sm btn-outline-light" href="/chat">Open Chat</a>
    </div>
  </div>

  <form class="row g-2 mb-3" method="GET" action="/messages">
    <div class="col-md-4 col-sm-6">
      <label class="form-label small text-muted mb-1">From</label>
      <input type="date" class="form-control" name="from" value="<%= from %>" />
    </div>
    <div class="col-md-4 col-sm-6">
      <label class="form-label small text-muted mb-1">To</label>
      <input type="date" class="form-control" name="to" value="<%= to %>" />
    </div>
    <div class="col-md-4 d-flex align-items-end gap-2">
      <button class="btn btn-primary flex-fill" type="submit">Filter</button>
      <% if (from || to) { %>
      <a class="btn btn-outline-secondary" href="/messages">Clear</a>
      <% } %>
    </div>
  </form>

  <div class="card border-0" style="background: rgba(15,23,42,0.55); border: 1px solid rgba(255,255,255,0.08) !important;">
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Sender</th>
            <th>Recipient</th>
            <th>Message</th>
            <th>Type</th>
            <th>Timestamp</th>
            <th style="width: 120px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (messages.length === 0) { %>
          <tr><td colspan="6" class="text-center text-muted py-4">No messages found.</td></tr>
          <% } %>
          <% messages.forEach((message) => { %>
          <tr>
            <td><code><%= message.sender %></code></td>
            <td><code><%= message.recipient %></code></td>
            <td class="text-truncate" style="max-width: 300px;">
              <% const imgKinds   = ['photo','document']; %>
              <% const videoKinds = ['sticker','animation','video','video_note']; %>
              <% const audioKinds = ['voice','audio']; %>
              <% if (message.mediaFileId && imgKinds.includes(message.kind)) { %>
                <a href="/tg-media/<%= message.mediaFileId %>" target="_blank" rel="noopener">
                  <img
                    src="/tg-media/<%= message.mediaThumbFileId || message.mediaFileId %>"
                    alt="<%= message.kind %>"
                    loading="lazy"
                    class="msg-thumb"
                  />
                </a>
                <% if (message.text && message.text.trim()) { %>
                  <div class="text-muted small text-truncate mt-1"><%= message.text.substring(0, 80) %></div>
                <% } %>
              <% } else if (message.mediaFileId && videoKinds.includes(message.kind)) { %>
                <a href="/tg-media/<%= message.mediaFileId %>" target="_blank" rel="noopener">
                  <video
                    src="/tg-media/<%= message.mediaFileId %>"
                    autoplay loop muted playsinline
                    class="msg-thumb"
                    title="<%= message.kind %>"
                  ></video>
                </a>
              <% } else if (message.mediaFileId && audioKinds.includes(message.kind)) { %>
                <audio controls src="/tg-media/<%= message.mediaFileId %>" style="height:32px;width:100%;max-width:220px"></audio>
              <% } else { %>
                <%= (message.text && message.text.trim())
                  ? message.text.substring(0, 120)
                  : "â€”" %>
              <% } %>
            </td>
            <td><span class="badge bg-dark"><%= message.kind || "text" %></span></td>
            <td class="text-nowrap"><%= new Date(message.timestamp).toLocaleString() %></td>
            <td>
              <div class="d-flex gap-1">
                <a href="/chat/<%= Math.min(message.sender, message.recipient) %>/<%= Math.max(message.sender, message.recipient) %>" class="btn btn-sm btn-outline-light" title="View chat">ðŸ’¬</a>
                <form
                  action="/message/<%= message._id %>/delete"
                  method="POST"
                  onsubmit="return confirm('Delete this message?');"
                  style="display:inline"
                >
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <button class="btn btn-sm btn-outline-danger" type="submit" title="Delete">ðŸ—‘</button>
                </form>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <% if (totalPages > 1) { %>
  <nav class="mt-3 d-flex justify-content-center">
    <ul class="pagination pagination-sm">
      <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
        <a class="page-link" href="/messages?page=<%= page - 1 %>&from=<%= encodeURIComponent(from) %>&to=<%= encodeURIComponent(to) %>">Prev</a>
      </li>
      <% for (let p = Math.max(1, page - 2); p <= Math.min(totalPages, page + 2); p++) { %>
      <li class="page-item <%= p === page ? 'active' : '' %>">
        <a class="page-link" href="/messages?page=<%= p %>&from=<%= encodeURIComponent(from) %>&to=<%= encodeURIComponent(to) %>"><%= p %></a>
      </li>
      <% } %>
      <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="/messages?page=<%= page + 1 %>&from=<%= encodeURIComponent(from) %>&to=<%= encodeURIComponent(to) %>">Next</a>
      </li>
    </ul>
  </nav>
  <% } %>
</div>

<%- include("partials/layout-bottom") %>
