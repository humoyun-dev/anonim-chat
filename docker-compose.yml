services:
  mongo:
    image: mongo:7
    container_name: mongo
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - mongo_data:/data/db
      - ./docker/mongo/init-replica.js:/docker-entrypoint-initdb.d/init-replica.js:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mongosh --quiet --host localhost:27017 --eval 'try { const s = rs.status(); if (s.ok !== 1) quit(1); } catch (e) { quit(1); }'",
        ]
      interval: 5s
      timeout: 5s
      retries: 30
    networks:
      - appnet
    restart: unless-stopped

  # Ensures the single-node replica set is initiated even when the mongo_data
  # volume already exists (docker-entrypoint-initdb.d runs only on first init).
  mongo-init:
    image: mongo:7
    container_name: mongo-init
    depends_on:
      - mongo
    volumes:
      - ./docker/mongo/init-replica.js:/scripts/init-replica.js:ro
    command:
      [
        "sh",
        "-c",
        "until mongosh --quiet --host mongo:27017 --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do echo 'Waiting for MongoDB...'; sleep 1; done; mongosh --quiet --host mongo:27017 /scripts/init-replica.js; echo 'Replica set init done.'",
      ]
    networks:
      - appnet
    restart: on-failure

  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: anonim-dashboard
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - MONGODB_URI=${MONGODB_URI_DASHBOARD:-mongodb://mongo:27017/anonim_chat?replicaSet=rs0}
      - SESSION_SECRET=${SESSION_SECRET}
      - ADMIN_USER=${ADMIN_USER}
      - ADMIN_PASS=${ADMIN_PASS}
      - COOKIE_SECURE=${COOKIE_SECURE:-0}
      - TRUST_PROXY=${TRUST_PROXY:-1}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - VIRTUAL_HOST=${DASHBOARD_DOMAIN:-}
      - VIRTUAL_PORT=3000
      - LETSENCRYPT_HOST=${DASHBOARD_DOMAIN:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    depends_on:
      - mongo
      - mongo-init
    networks:
      - appnet
      - webnet
    restart: unless-stopped

  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    container_name: anonim-bot
    environment:
      - MONGODB_URI=${MONGODB_URI_BOT:-mongodb://mongo:27017/anonim_chat?replicaSet=rs0}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - BOT_USERNAME=${BOT_USERNAME}
      - REVEAL_STARS_COST=${REVEAL_STARS_COST:-50}
      - PAY_SUPPORT_TEXT=${PAY_SUPPORT_TEXT:-}
      - PAY_SUPPORT_TEXT_EN=${PAY_SUPPORT_TEXT_EN:-}
      - PAY_SUPPORT_TEXT_RU=${PAY_SUPPORT_TEXT_RU:-}
      - PAY_SUPPORT_TEXT_UZ=${PAY_SUPPORT_TEXT_UZ:-}
    depends_on:
      - mongo
      - mongo-init
    networks:
      - appnet
    restart: unless-stopped

  nginx-proxy:
    image: jwilder/nginx-proxy:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs:/etc/nginx/certs:rw
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
      - /var/run/docker.sock:/tmp/docker.sock:ro
    environment:
      - CLIENT_MAX_BODY_SIZE=100m
    networks:
      - webnet
    restart: unless-stopped

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: letsencrypt
    environment:
      - NGINX_PROXY_CONTAINER=nginx-proxy
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - ./certs:/etc/nginx/certs:rw
      - ./data/letsencrypt:/etc/acme.sh
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - webnet
    restart: unless-stopped
    depends_on:
      - nginx-proxy

volumes:
  mongo_data:

networks:
  webnet:
    driver: bridge
  appnet:
    driver: bridge
